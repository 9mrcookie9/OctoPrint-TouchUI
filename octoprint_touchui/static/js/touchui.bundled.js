var TouchUI=function(){return this.core.init.call(this),this.knockout.viewModel.call(this),this.knockout.bindings.call(this),this.core.bridge.call(this)};if(TouchUI.prototype={constructor:TouchUI,isActive:ko.observable(!1),settings:{id:"touch",version:0,isFullscreen:ko.observable(!1),isTouchscreen:ko.observable(!1),isEpiphanyOrKweb:-1!==window.navigator.userAgent.indexOf("AppleWebKit")&&-1!==window.navigator.userAgent.indexOf("ARM Mac OS X"),hasFullscreen:ko.observable(document.webkitCancelFullScreen||document.msCancelFullScreen||document.oCancelFullScreen||document.mozCancelFullScreen||document.cancelFullScreen),hasLocalStorage:"localStorage"in window,hasTouch:"ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0,canLoadAutomatically:$("#loadsomethingsomethingdarkside").length>0,touchuiModal:$("#touchui_settings_dialog"),whatsNew:ko.observable(!1)},core:{},components:{},knockout:{},plugins:{},animate:{isHidebarActive:ko.observable(!1)},DOM:{create:{},move:{},overwrite:{}},scroll:{defaults:{iScroll:{scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale",fadeScrollbars:!0,disablePointer:!0}},iScrolls:{},currentActive:null}},TouchUI.prototype.animate.hide=function(o){var e=this;if("navbar"===o&&this.animate.isHidebarActive()){var t=$("#navbar"),n=parseFloat(t.height());if(this.settings.hasTouch)window.scrollTo(0,1),parseFloat($("html,body").prop("scrollHeight"))>$(window).height()+n&&$("html,body").stop().animate({scrollTop:n},160,"swing");else{var i=e.scroll.iScrolls.body;if(i.isAnimating)return void setTimeout(function(){e.animate.hide.call(e,o)},10);setTimeout(function(){Math.abs(i.maxScrollY)>0&&i.scrollTo(0,-n,160)},0)}}},TouchUI.prototype.components.dropdown={init:function(){this.components.dropdown.toggleSubmenu.call(this),this.components.dropdown.toggle.call(this)},toggle:function(){var o=this,e=".touchui.dropdown";$(document).off(".dropdown").on("touchstart.dropdown.data-api",".dropdown-menu",function(o){o.stopPropagation()}).on("click.dropdown.data-api","[data-toggle=dropdown]",function(t){var n=$(t.currentTarget),i=n.parent();t.preventDefault(),i.toggleClass("open"),o.components.dropdown.containerMinHeight.call(o,i,n),i.parents(".open > .dropdown-menu").length>0||($('.open [data-toggle="dropdown"]').not(n).parent().removeClass("open"),o.settings.hasTouch||o.scroll.iScrolls.terminal.disable(),$(document).off("click"+e).on("click"+e,function(e){var t=o.settings.hasTouch?!1:o.scroll.currentActive.moved,n=$(e.target);t||0!==n.parents(".ui-pnotify").length||n.parents().is(i)&&!n.is('a:not([data-toggle="dropdown"])')||($(document).off(e),i.removeClass("open"),o.settings.hasTouch||($(".octoprint-container").css("min-height",0),o.scroll.currentActive.refresh(),o.scroll.iScrolls.terminal.enable()))}))})},toggleSubmenu:function(){$(".dropdown-submenu").addClass("dropdown"),$(".dropdown-submenu > a").attr("data-toggle","dropdown")},containerMinHeight:function(o,e){var t=this;if(!t.settings.hasTouch){var n=0===o.parents(".modal").length?$(".octoprint-container"):o.parents(".modal .modal-body"),i=o.parents(".open > .dropdown-menu").length>0?o.parents(".open > .dropdown-menu"):e.next();setTimeout(function(){if(i.parent().hasClass("open")){var o=Math.abs(t.scroll.currentActive.y),e=i.outerHeight(),r=i.offset().top;n.css("min-height",o+r+e),t.scroll.currentActive.refresh()}else n.css("min-height",0),t.scroll.currentActive.refresh()},0)}}},TouchUI.prototype.components.fullscreen={init:function(){var o=this;$(document).bind("fullscreenchange",function(){o.settings.isFullscreen($(document).fullScreen()!==!1),o.DOM.storage.set("fullscreen",o.settings.isFullscreen())})},ask:function(){var o=this;o.settings.hasFullscreen()&&new PNotify({title:"Fullscreen",text:"Would you like to go fullscreen?",icon:"glyphicon glyphicon-question-sign",type:"info",hide:!1,addclass:"askFullscreen",confirm:{confirm:!0,buttons:[{text:"Yes",addClass:"btn-primary",click:function(o){o.remove(),$(document).fullScreen(!0)}},{text:"No",click:function(o){o.remove(),$(document).trigger("fullscreenchange")}}]},buttons:{closer:!1,sticker:!1},history:{history:!1}})}},TouchUI.prototype.components.keyboard={isActive:ko.observable(!1),config:{"default":{display:{accept:"Save",bksp:" ","default":"ABC",meta1:".?123",meta2:"#+="},layout:"custom",customLayout:{"default":["q w e r t y u i o p","a s d f g h j k l","{bksp} {s} z x c v b n m","{accept} {c} {left} {right} {meta1} {space}"],shift:["Q W E R T Y U I O P","A S D F G H J K L","{bksp} {s} Z X C V B N M","{accept} {c} {left} {right} {meta1} {space}"],meta1:["1 2 3 4 5 6 7 8 9 0","- / : ; ( ) € & @","{bksp} {meta2} . , ? ! ' \"","{accept} {c} {left} {right} {default} {space}"],meta2:["[ ] { } # % ^ * + =","_ \\ | ~ < > $ £ ¥","{bksp} {meta1} . , ? ! ' \"","{accept} {c} {left} {right} {default} {space}"]}},terminal:{display:{bksp:" ",accept:"Save","default":"ABC",meta1:".?123",meta2:"#+="},layout:"custom",customLayout:{"default":["Q W E R T Y U I O P","A S D F G H J K L","{bksp} {s} Z X C V B N M","{accept} {c} {left} {right} {meta1} {space}"],meta1:["1 2 3 4 5 6 7 8 9 0","- / : ; ( ) € & @","{bksp} {meta2} . , ? ! ' \"","{accept} {c} {left} {right} {default} {space}"],meta2:["[ ] { } # % ^ * + =","_ \\ | ~ < > $ £ ¥","{bksp} {meta1} . , ? ! ' \"","{accept} {c} {left} {right} {default} {space}"]}},number:{display:{bksp:" ",a:"Save",c:"Cancel"},layout:"custom",customLayout:{"default":["{bksp} 1 2 3 4 5 6 7 ","{accept} {c} {left} {right} 8 9 0 - , . "]}}},init:function(){var o=this,e={visible:o.components.keyboard.onShow,beforeClose:o.components.keyboard.onClose},t=['[type="file"]','[type="checkbox"]','[type="radio"]'];$(document).on("mousedown","input:not("+t+"), textarea",function(t){var n=$(t.target);if(o.components.keyboard.isActive()){if(o.settings.hasTouch||(o.scroll.currentActive._end(t),setTimeout(function(){o.scroll.currentActive.scrollToElement(n[0],200,0,-30)},0)),n.data("keyboard"))return void n.data("keyboard").reveal();"number"===n.attr("type")?n.keyboard($.extend(o.components.keyboard.config.number,e)):"terminal-command"===n.attr("id")?n.keyboard($.extend(o.components.keyboard.config.terminal,e)):n.keyboard($.extend(o.components.keyboard.config["default"],e))}else n.data("keyboard")&&n.data("keyboard").close().destroy()})},onShow:function(o,e,t){e.$keyboard.find("button").on("mousedown",function(o){$(o.target).addClass("touch-focus"),"function"!=typeof $(o.target).data("timeout")&&clearTimeout($(o.target).data("timeout"));var e=setTimeout(function(){$(o.target).removeClass("touch-focus").data("timeout","")},600);$(o.target).data("timeout",e)})},onClose:function(o,e,t){e.$keyboard.find("button").off("mousedown")}},TouchUI.prototype.components.modal={init:function(){$("#settings_dialog_menu").length>0&&this.components.modal.dropdown.create.call(this,"#settings_dialog_menu","special-dropdown-uni","#settings_dialog_label"),$("#usersettings_dialog ul.nav").length>0&&this.components.modal.dropdown.create.call(this,"#usersettings_dialog ul.nav","special-dropdown-uni-2","#usersettings_dialog h3")},dropdown:{create:function(o,e,t){var n=this;$(t).text($(t).text().trim());var i=$("<span></span>").addClass("hidden").attr("id",e).appendTo(t).text($(o+" .active").text().trim()).on("click",function(t){if(!(t.target!==this||t.target===this&&$(".show-dropdown").length>0)){var r=$(o).clone().attr("id","").appendTo(this).addClass("show-dropdown");$(document).on("click",function(o){if($(o.target).closest('[data-toggle="tab"]').length>0||0===$(o.target).closest("#"+e).length){var t=i.find(".active").find('[data-toggle="tab"]').attr("href");$(document).off(o).trigger("dropdown-closed.touchui"),$(".show-dropdown").remove(),$('[href="'+t+'"]').click(),i.text($('[href="'+t+'"]').text()),n.settings.hasTouch||setTimeout(function(){n.scroll.modal.stack[n.scroll.modal.stack.length-1].refresh()},0)}}),$(document).trigger("dropdown-open.touchui",r[0])}});$(t).closest(".modal").on("modal.touchui",function(){var e=$(o).find(".active").find('[data-toggle="tab"]').attr("href");i.text($('[href="'+e+'"]').text())})}}},TouchUI.prototype.components.slider={init:function(){ko.bindingHandlers.slider={init:function(o,e){var t=$(o);t.val(e().value());var n=$('<div class="slider-container"></div>').insertBefore(o);setTimeout(function(){var e=$(o).next("button"),i=_.uniqueId("ui-inp");e.appendTo(n),t.appendTo(n),$(n).find("input").attr("id",i);var r=$('<label for="'+i+'" style="display: inline-block;">'+e.text().split(":")[0].replace(" ","")+":</label>");r.appendTo(".octoprint-container"),t.attr("style","padding-left:"+(r.width()+15)+"px"),r.appendTo(n)},60),t.on("change",function(o){e().value(t.val())}).attr({max:e().max,min:e().min,step:e().step})},update:function(o,e){$(o).val(e().value())}}}},TouchUI.prototype.components.touchList={init:function(){var o=!1,e=0,t=".files.touchui";$(document).on("mousedown touchstart","#files .entry:not(.folder, .back), #temp .row-fluid",function(n){try{o=n.currentTarget,e=n.pageX||n.originalEvent.targetTouches[0].pageX}catch(i){return}$(document).one("mouseup"+t+" touchend"+t,function(n){o=!1,e=0,$(document).off(t)}),$(document).on("mousemove"+t+" touchmove"+t,function(n){if(o!==!1)try{var i=n.pageX||n.originalEvent.targetTouches[0].pageX;i>e+80?($(document).trigger("fileclose"+t,n.target),$(o).removeClass("open"),e=i):e-80>i&&($(document).trigger("fileopen"+t,n.target),$(o).addClass("open"),e=i,$(o).find(".btn-group").children().length>4&&$(o).addClass("large"))}catch(r){}})})}},TouchUI.prototype.components.touchscreen={init:function(){$("html").addClass("isTouchscreenUI"),this.settings.hasTouch=!1,this.settings.isTouchscreen(!0),this.settings.isEpiphanyOrKweb&&this.settings.hasFullscreen(!1),this.scroll.defaults.iScroll.scrollbars=!1,this.scroll.defaults.iScroll.interactiveScrollbars=!1,this.scroll.defaults.iScroll.useTransition=!1},isLoading:function(o){this.settings.isTouchscreen()&&o.terminalViewModel.enableFancyFunctionality&&o.terminalViewModel.enableFancyFunctionality(!1)}},TouchUI.prototype.core.init=function(){this.DOM.storage.migration.call(this),this.core.boot.call(this)&&($("html").attr("id",this.settings.id),$('<meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no, minimal-ui">').appendTo("head"),$('<meta name="apple-mobile-web-app-capable" content="yes">').appendTo("head"),$('<meta name="mobile-web-app-capable" content="yes">').appendTo("head"),this.isActive(!0),this.DOM.storage.set("active",!0),void 0===this.DOM.storage.get("keyboardActive")&&(this.settings.hasTouch?this.DOM.storage.set("keyboardActive",!1):this.DOM.storage.set("keyboardActive",!0)),void 0===this.DOM.storage.get("hideNavbarActive")&&this.DOM.storage.set("hideNavbarActive",!1),void 0===this.DOM.storage.get("fullscreen")?(this.DOM.storage.set("fullscreen",!1),this.components.fullscreen.ask.call(this)):this.DOM.storage.get("fullscreen")&&this.components.fullscreen.ask.call(this),(this.settings.isEpiphanyOrKweb||this.DOM.storage.get("touchscreenActive"))&&this.components.touchscreen.init.call(this),this.components.keyboard.isActive(this.DOM.storage.get("keyboardActive")),this.animate.isHidebarActive(this.DOM.storage.get("hideNavbarActive")),this.settings.isFullscreen(this.DOM.storage.get("fullscreen")))},TouchUI.prototype.core.boot=function(){if("#touch"===document.location.hash||document.location.href.indexOf("?touch")>0||this.DOM.storage.get("active"))return!0;if(this.settings.canLoadAutomatically&&this.DOM.storage.get("active")!==!1){if($(window).width()<980)return!0;if(this.settings.hasTouch)return!0}return!1},TouchUI.prototype.core.bridge=function(){var o=this;return this.core.bridge={allViewModels:{},domLoading:function(){o.isActive()&&(o.scroll.beforeLoad.call(o),o.DOM.init.call(o))},domReady:function(){o.isActive()&&(o.components.dropdown.init.call(o),o.components.fullscreen.init.call(o),o.components.keyboard.init.call(o),o.components.modal.init.call(o),o.components.touchList.init.call(o),o.components.slider.init.call(o),o.scroll.init.call(o))},koStartup:function(e){return o.core.bridge.allViewModels=_.object(TOUCHUI_REQUIRED_VIEWMODELS,e),o.knockout.isLoading.call(o,o.core.bridge.allViewModels),o}},this.core.bridge},TouchUI.prototype.core.less={options:{template:{importUrl:"/plugin/touchui/static/less/touchui.bundled.less","import":'@import "{importUrl}"; \n',variables:"@main-color: {mainColor}; \n@terminal-color: {termColor}; \n@text-color: {textColor}; \n@main-background: {bgColor}; \n\n"},API:"/plugin/touchui/css"},save:function(){var o=this.core.less.options,e=this;e.settings.useCustomization()&&(e.settings.colors.useLocalFile()?$.get(o.API,{path:e.settings.colors.customPath()}).done(function(t){e.core.less.render.call(e,o.template["import"].replace("{importUrl}",o.template.importUrl)+t)}).error(function(o){e.core.less.error.call(e,o)}):e.core.less.render.call(e,""+o.template["import"].replace("{importUrl}",o.template.importUrl)+o.template.variables.replace("{mainColor}",e.settings.colors.mainColor()).replace("{termColor}",e.settings.colors.termColor()).replace("{textColor}",e.settings.colors.textColor()).replace("{bgColor}",e.settings.colors.bgColor())))},render:function(o){var e=this,t=function(o,t){o?e.core.less.error.call(e,o):$.post(e.core.less.options.API,{css:t.css}).done(function(){e.settings.requireNewCSS()&&e.settings.refreshCSS("fast")}).error(function(o){e.core.less.error.call(e,o)})};window.less.render?window.less.render(o,{compress:!0},t):window.less.Parser({}).parse(o,function(o,e){e&&(e={css:e.toCSS({compress:!0})}),t.call(this,o,e)})},error:function(o){var e=o.responseText;e&&e.trim()&&401!==o.status&&new PNotify({title:"TouchUI: Whoops, something went wrong...",text:e,icon:"glyphicon glyphicon-question-sign",type:"error",hide:!1})}},TouchUI.prototype.core.version={init:function(o){$("<span></span>").appendTo("#terminal-output"),o&&o.versions.items.subscribe(function(e){if(touchui=o.versions.getItem(function(o){return"touchui"===o.key},!0)||!1,touchui!==!1&&null!==touchui.information){var t=Number(touchui.information.remote.value.split(".").join("")),n=Number(touchui.information.local.value.split(".").join(""));t>n?($("#touch_updates_css").remove(),$("head").append('<style id="touch_updates_css">#term pre span:first-child:before{ content: "v'+touchui.information.local.value+" outdated, new version: v"+touchui.information.remote.value+'" !important; }</style>')):0===$("#touch_updates_css").length&&$("head").append('<style id="touch_updates_css">#term pre span:first-child:before{ content: "v'+touchui.information.local.value+'" !important; }</style>')}})}},TouchUI.prototype.DOM.init=function(){this.DOM.create.printer.init(this.DOM.create.tabbar),this.DOM.create.printer.menu.$elm.find("a").trigger("click"),this.DOM.create.dropdown.init.call(this.DOM.create.dropdown),this.DOM.move.tabbar.init.call(this),this.DOM.move.navbar.init.call(this),this.DOM.move.afterTabAndNav.call(this),this.DOM.move.overlays.init.call(this),this.DOM.move.terminal.init.call(this),this.DOM.move.connection.init(this.DOM.create.tabbar),this.DOM.move.controls.init(),this.DOM.overwrite.tabdrop.call(self),this.DOM.overwrite.modal.call(self),$("#webcam_container").length>0&&this.DOM.create.webcam.init(this.DOM.create.tabbar),$("#tabs, #navbar").addClass("items-"+$("#tabs li:not(.hidden_touch)").length),$("#tabs [data-toggle=tab]").on("click",function(){$("#all_touchui_settings").removeClass("item_active")})},TouchUI.prototype.DOM.cookies={get:function(o){for(var e="TouchUI."+o+"=",t=document.cookie.split(";"),n=0;n<t.length;n++){for(var i=t[n];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(e))return $.parseJSON(i.substring(e.length,i.length))}},set:function(o,e){var t=new Date;t.setTime(t.getTime()+31104e6);var n="expires="+t.toUTCString();document.cookie="TouchUI."+o+"="+e+"; "+n},toggleBoolean:function(o){var e=$.parseJSON(this.get(o)||"false");return e===!0?this.set(o,"false"):this.set(o,"true"),!e}},TouchUI.prototype.DOM.localstorage={store:JSON.parse(localStorage.TouchUI||"{}"),get:function(o){return this.store[o]},set:function(o,e){return this.store[o]=e,localStorage.TouchUI=JSON.stringify(this.store),this.store[o]},toggleBoolean:function(o){var e=this.store[o]||!1;return e===!0?this.set(o,!1):this.set(o,!0),!e}},TouchUI.prototype.settings.hasLocalStorage)try{localStorage.TouchUIcanWeHazStorage="true",TouchUI.prototype.DOM.storage=TouchUI.prototype.DOM.localstorage,delete localStorage.TouchUIcanWeHazStorage}catch(err){TouchUI.prototype.settings.isEpiphanyOrKweb&&$(function(){new PNotify({type:"error",title:"Private Mode detection:",text:"Edit the startup file 'start_kweb3.xinit' in '~/OctoPrint-TouchUI-autostart/' and add the parameter 'P' after the dash. \n\nFor more information see the v0.3.3 release notes.",hide:!1})}),console.info("Localstorage defined but failback to cookies due to errors."),TouchUI.prototype.DOM.storage=TouchUI.prototype.DOM.cookies}else TouchUI.prototype.DOM.storage=TouchUI.prototype.DOM.cookies;TouchUI.prototype.DOM.storage.migration=TouchUI.prototype.DOM.storage===TouchUI.prototype.DOM.localstorage?function(){if(this.settings.hasLocalStorage&&-1!==document.cookie.indexOf("TouchUI.")){console.info("TouchUI cookies migration.");for(var o="TouchUI.",e=document.cookie.split(";"),t=0;t<e.length;t++){for(var n=e[t];" "==n.charAt(0);)n=n.substring(1);if(0==n.indexOf(o)){var i=n.substring(o.length,n.length);i=i.split("=");var r=$.parseJSON(i[1]);console.info("Saving cookie",i[0],"with value",r,"to localstorage."),this.DOM.storage.set(i[0],r),console.info("Removing cookie",i[0]),document.cookie="TouchUI."+i[0]+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT;"}}}}:_.noop,TouchUI.prototype.knockout.bindings=function(){var o=this;this.bindings={toggleTouch:function(){o.DOM.storage.toggleBoolean("active")?document.location.hash="#touch":document.location.hash="",document.location.reload()},toggleKeyboard:function(){o.isActive()&&o.components.keyboard.isActive(o.DOM.storage.toggleBoolean("keyboardActive"))},toggleHidebar:function(){o.isActive()&&o.animate.isHidebarActive(o.DOM.storage.toggleBoolean("hideNavbarActive"))},toggleFullscreen:function(){$(document).toggleFullScreen()},toggleTouchscreen:function(){o.isActive()&&(o.settings.isTouchscreen(o.DOM.storage.toggleBoolean("touchscreenActive")),document.location.reload())},show:function(){o.settings.touchuiModal.modal("show")}}},TouchUI.prototype.knockout.isLoading=function(o){var e=this;e.isActive()&&(e.components.touchscreen.isLoading.call(e,o),$("#printer_connect").on("click",function(o){var e=$(o.target);e.prop("disabled",!0),setTimeout(function(){e.prop("disabled",!1)},600)}),e.settings.hasTouch||o.gcodeFilesViewModel.listHelper.paginatedItems.subscribe(function(o){setTimeout(function(){e.scroll.iScrolls.body.refresh()},300)}),o.connectionViewModel.isOperational.subscribe(function(o){var e=$("#all_touchui_settings");o?(e.removeClass("offline").addClass("online"),$("#conn_link2").removeClass("offline").addClass("online")):(e.addClass("offline").removeClass("online"),$("#conn_link2").addClass("offline").removeClass("online"))}),o.gcodeViewModel&&e.settings.isTouchscreen()&&(console.info("TouchUI: Disabling GCodeViewer in touchscreen mode..."),o.gcodeViewModel.enabled=!1,o.gcodeViewModel.initialize=_.noop,o.gcodeViewModel._processData=_.noop,$("#gcode_link2").hide())),e.settings.whatsNew.subscribe(function(o){o!==!1&&""!=o.trim()&&new PNotify({title:"TouchUI: What's new?",text:o,icon:"glyphicon glyphicon-question-sign",type:"info",hide:!1})})},TouchUI.prototype.knockout.isReady=function(o){var e=this;if(e.isActive()){if($(window).on("resize",function(){o.temperatureViewModel.updatePlot()}),$(".gcode_files").slimScroll({destroy:!0}),$(".slimScrollDiv").slimScroll({destroy:!0}),e.components.keyboard.isActive.subscribe(function(o){o||$(".ui-keyboard-input").each(function(o,e){$(e).data("keyboard").destroy()})}),$(document).off("dragover"),o.gcodeFilesViewModel._enableDragNDrop&&(o.gcodeFilesViewModel._enableDragNDrop=function(){}),o.settingsViewModel.loginState.loggedIn.subscribe(function(o){o&&$(".open > .dropdown-menu").length>0&&$(document).trigger("click")}),$("#term .terminal small.pull-right").html('<a href="#"><i class="fa fa-angle-double-down"></i></a>').on("click",function(){return o.terminalViewModel.scrollToEnd(),!1}),$("#terminal-output-lowfi").prop("scrollHeight")&&o.terminalViewModel.plainLogOutput.subscribe(function(){$("#terminal-output-lowfi").height($("#terminal-output-lowfi").prop("scrollHeight"))}),this.scroll.overwrite.call(this,o.terminalViewModel),this.core.version.init.call(this,o.softwareUpdateViewModel),$("#webcam").length&&ko.applyBindings(o.controlViewModel,$("#webcam")[0]),$("#navbar_login").length){try{ko.applyBindings(o.navigationViewModel,$("#navbar_login")[0])}catch(t){}o.navigationViewModel.loginState.loggedIn.subscribe(function(o){o?($("#navbar_login a.dropdown-toggle").addClass("hidden_touch"),$("#login_dropdown_loggedin").removeClass("hide dropdown open").addClass("visible_touch")):($("#navbar_login a.dropdown-toggle").removeClass("hidden_touch"),$("#login_dropdown_loggedin").removeClass("visible_touch")),e.settings.hasTouch||setTimeout(function(){e.scroll.currentActive.refresh()},0)})}$("#navbar_systemmenu").length&&(ko.applyBindings(o.navigationViewModel,$("#navbar_systemmenu")[0]),ko.applyBindings(o.navigationViewModel,$("#divider_systemmenu")[0])),$(".colorPicker").tinycolorpicker().on("change",function(o,e,t,n){n!==!1&&$(this).find("input").trigger("change",[e,t,!1])});var n=function(o){return o.split("?")[0]+"?ts="+(new Date).getMilliseconds()};e.settings.refreshCSS.subscribe(function(o){(o||"fast"===o)&&setTimeout(function(){var o=$("#touchui-css");o.attr("href",n(o.attr("href"))),e.settings.refreshCSS(!1)},"fast"===o?0:1200)}),e.settings.hasCustom.subscribe(function(o){if(""!==o){var e=$("#touchui-css"),t=e.attr("href");t=o?t.replace("touchui.css","touchui.custom.css"):t.replace("touchui.custom.css","touchui.css"),e.attr("href",n(t))}})}var i=ko.computed(function(){return e.settings.requireNewCSS()&&o.loginStateViewModel.isAdmin()});i.subscribe(function(o){o&&setTimeout(function(){e.core.less.save.call(e,e)},100)})},TouchUI.prototype.knockout.viewModel=function(){var o=this;o.onStartupComplete=function(){o.isActive()&&o.DOM.overwrite.tabbar.call(o),o.knockout.isReady.call(o,o.core.bridge.allViewModels),o.isActive()&&o.plugins.init.call(o,o.core.bridge.allViewModels)},o.onBeforeBinding=function(){ko.mapping.fromJS(o.core.bridge.allViewModels.settingsViewModel.settings.plugins.touchui,{},o.settings)},o.onSettingsBeforeSave=function(){o.core.less.save.call(o)},o.onTabChange=function(){o.isActive()&&(o.animate.hide.call(o,"navbar"),!o.settings.hasTouch&&o.scroll.currentActive&&(o.scroll.currentActive.refresh(),setTimeout(function(){o.scroll.currentActive.refresh()},0)))}},TouchUI.prototype.plugins.init=function(o){this.plugins.screenSquish(o.pluginManagerViewModel)},TouchUI.prototype.plugins.navbarTemp=function(){if($("#navbar_plugin_navbartemp").length>0){var o=$("#navbar_plugin_navbartemp").appendTo(this.DOM.create.dropdown.container);$('<li class="divider"></li>').insertBefore(o)}},TouchUI.prototype.plugins.screenSquish=function(o){var e=!1;o.plugins.items.subscribe(function(){var t=o.plugins.getItem(function(o){return"ScreenSquish"===o.key},!0)||!1;!e&&t&&t.enabled&&(e=!0,new PNotify({title:"TouchUI: ScreenSquish is running",text:"Running ScreenSquish and TouchUI will give issues since both plugins try the same, we recommend turning off ScreenSquish.",icon:"glyphicon glyphicon-question-sign",type:"error",hide:!1,confirm:{confirm:!0,buttons:[{text:"Disable ScreenSquish",addClass:"btn-primary",click:function(e){t.pending_disable||o.togglePlugin(t),e.remove()}}]}}))})},TouchUI.prototype.scroll.beforeLoad=function(){this.settings.hasTouch||($('<div id="scroll"></div>').insertBefore(".page-container"),$(".page-container").appendTo("#scroll"))},TouchUI.prototype.scroll.init=function(){var o=this;if(this.settings.hasTouch){var e=$(window).width();$("#temperature-graph").parent().height($("#temperature-graph").parent().outerHeight()),$("#terminal-scroll").height($("#terminal-scroll").outerHeight()),$("#terminal-sendpanel").css("top",$("#terminal-scroll").outerHeight()-1),$(window).on("resize",function(){e!==$(window).width()&&($("#temperature-graph").parent().height($("#temperature-graph").parent().outerHeight()),$("#terminal-scroll").css("height","").height($("#terminal-scroll").outerHeight()),$("#terminal-sendpanel").css("top",$("#terminal-scroll").outerHeight()-1),e=$(window).width())})}else $("html").addClass("emulateTouch"),o.scroll.terminal.init.call(o),o.scroll.body.init.call(o),o.scroll.modal.init.call(o),o.scroll.overlay.init.call(o),$(document).on("slideCompleted",function(){o.scroll.currentActive.refresh()}),$(document).on("click",".pagination ul li a",function(){setTimeout(function(){o.scroll.currentActive.refresh()},0)})},TouchUI.prototype.scroll.blockEvents={className:"no-pointer",scrollStart:function(o,e){o.addClass(this.className)},scrollEnd:function(o,e){o.removeClass(this.className),e.refresh()}},TouchUI.prototype.scroll.body={init:function(){var o=this,e=!1,t=$(".page-container");o.scroll.iScrolls.body=new IScroll("#scroll",o.scroll.defaults.iScroll),o.scroll.currentActive=o.scroll.iScrolls.body;var e=o.scroll.blockEvents.scrollStart.bind(o.scroll.blockEvents,t,o.scroll.iScrolls.body),n=o.scroll.blockEvents.scrollEnd.bind(o.scroll.blockEvents,t,o.scroll.iScrolls.body);o.scroll.iScrolls.body.on("scrollStart",e),o.scroll.iScrolls.body.on("onBeforeScrollStart",e),o.scroll.iScrolls.body.on("scrollEnd",n),o.scroll.iScrolls.body.on("scrollCancel",n),$(document).on("mouseup.prevent.pointer touchend.prevent.pointer",function(){t.removeClass("no-pointer")})}},TouchUI.prototype.scroll.modal={stack:[],dropdown:null,init:function(){var o=$(document),e=this;o.on("modal.touchui",function(t,n){var i=$(n),r=$(n).parent(),l=new IScroll(r[0],e.scroll.defaults.iScroll);e.scroll.modal.stack.push(l),e.scroll.currentActive=l,setTimeout(function(){l&&l.refresh()},0),setTimeout(function(){l&&l.refresh()},800);var s=e.scroll.blockEvents.scrollStart.bind(e.scroll.blockEvents,i,l),a=e.scroll.blockEvents.scrollEnd.bind(e.scroll.blockEvents,i,l);l.on("scrollStart",s),l.on("scrollEnd",a),l.on("scrollCancel",a),o.on("click.scrollHeightTouchUI",'[data-toggle="tab"], .pagination ul li a',function(o){l._end(o),setTimeout(function(){l.refresh(),l.scrollTo(0,0)},0)}),i.one("destroy",function(){o.off("click.scrollHeightTouchUI"),e.scroll.modal.stack.pop(),e.scroll.modal.stack.length>0?e.scroll.currentActive=e.scroll.modal.stack[e.scroll.modal.stack.length-1]:e.scroll.currentActive=e.scroll.iScrolls.body,l.destroy(),l.off("scrollStart",s),l.off("scrollEnd",a),l.off("scrollCancel",a),l=void 0})}),o.on("dropdown-open.touchui",function(t,n){var i=$(n);e.scroll.modal.dropdown=new IScroll(n,{scrollbars:!0,mouseWheel:!0,interactiveScrollbars:!0,shrinkScrollbars:"scale"}),e.scroll.modal.dropdown.scrollToElement(i.find("li.active")[0],0,0,-30),e.scroll.modal.stack[e.scroll.modal.stack.length-1].disable();var r=e.scroll.blockEvents.scrollStart.bind(e.scroll.blockEvents,i,e.scroll.modal.dropdown),l=e.scroll.blockEvents.scrollEnd.bind(e.scroll.blockEvents,i,e.scroll.modal.dropdown);e.scroll.modal.dropdown.on("scrollStart",r),e.scroll.modal.dropdown.on("scrollEnd",l),e.scroll.modal.dropdown.on("scrollCancel",l),o.on("dropdown-closed.touchui",function(){e.scroll.modal.stack[e.scroll.modal.stack.length-1].enable(),e.scroll.modal.dropdown.off("scrollStart",r),e.scroll.modal.dropdown.off("scrollEnd",l),e.scroll.modal.dropdown.off("scrollCancel",l)})})}},TouchUI.prototype.scroll.overlay={mainItems:["#offline_overlay","#reloadui_overlay"],init:function(){var o=this;o.scroll.iScrolls.overlay=[],$items=$(this.scroll.overlay.mainItems),$items.each(function(e,t){var n=$(t).children("#"+$(t).attr("id")+"_wrapper"),i=$("<div></div>").prependTo(t);n.appendTo(i),$(t).addClass("iscroll"),o.scroll.iScrolls.overlay[e]=new IScroll(t,o.scroll.defaults.iScroll)})},refresh:function(){var o=this;setTimeout(function(){$.each(o.scroll.iScrolls.overlay,function(e){o.scroll.iScrolls.overlay[e].refresh()})},0)}},TouchUI.prototype.scroll.overwrite=function(o){var e=this;if(this.settings.hasTouch)o.scrollToEnd=function(){var o=$("#terminal-scroll");o.length&&o.scrollTop(o[0].scrollHeight-o.height())};else{$("#scroll").on("scroll",function(){0!==$("#scroll").scrollTop()&&$("#scroll").scrollTop(0)}),o.displayedLines.subscribe(function(){e.scroll.iScrolls.terminal.refresh()}),o.scrollToEnd=function(){e.scroll.iScrolls.terminal.refresh(),e.scroll.iScrolls.terminal.scrollTo(0,e.scroll.iScrolls.terminal.maxScrollY)};var t=window.showOfflineOverlay;window.showOfflineOverlay=function(o,n,i){t.call(this,o,n,i),e.scroll.overlay.refresh.call(e)};var n=window.showConfirmationDialog;window.showConfirmationDialog=function(o,t){e.scroll.iScrolls.body.scrollTo(0,0,500),n.call(this,o,t)};var i=$.fn.show;$.fn.show=function(o,t,n){return $(this).hasClass("iscroll")&&setTimeout(function(){e.scroll.overlay.refresh.call(e)},0),i.call(this,o,t,n)}}},TouchUI.prototype.scroll.terminal={init:function(){var o=this;o.scroll.iScrolls.terminal=new IScroll("#terminal-scroll",o.scroll.defaults.iScroll),o.scroll.iScrolls.terminal.on("beforeScrollStart",function(){o.scroll.iScrolls.terminal.refresh(),this.hasVerticalScroll&&o.scroll.iScrolls.body.disable()}),o.scroll.iScrolls.terminal.on("scrollEnd",function(){o.scroll.iScrolls.body.enable()})}},TouchUI.prototype.DOM.create.dropdown={menuItem:{cloneTo:$("#navbar ul.nav")},container:null,init:function(){this.menuItem.menu=$('<li id="all_touchui_settings" class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown">'+$("navbar_show_settings").text()+"</a></li>").prependTo(this.menuItem.cloneTo),this.container=$('<ul class="dropdown-menu"></ul>').appendTo(this.menuItem.menu)}},TouchUI.prototype.DOM.create.printer={menu:{cloneTo:"#tabs"},container:{cloneTo:"#temp"},move:{$state:$("#state_wrapper"),$files:$("#files_wrapper")},init:function(o){this.menu.$elm=o.createItem("print_link","printer","tab").prependTo(this.menu.cloneTo),this.container.$elm=$('<div id="printer" class="tab-pane active"><div class="row-fluid"></div></div>').insertBefore(this.container.cloneTo),this.move.$state.appendTo(this.container.$elm.find(".row-fluid")),this.move.$files.insertAfter(this.container.$elm.find(".row-fluid #state_wrapper"))}},TouchUI.prototype.DOM.create.tabbar={createItem:function(o,e,t,n){return n=n?n:"",$('<li id="'+o+'"><a href="#'+e+'" data-toggle="'+t+'">'+n+"</a></li>")}},TouchUI.prototype.DOM.create.webcam={menu:{webcam:{cloneTo:"#term_link"}},container:{cloneTo:".tab-content",webcam:{$container:$("#webcam_container"),cloneTo:"#webcam"}},init:function(o){this.container.$elm=$('<div id="webcam" class="tab-pane"></div>').appendTo(this.container.cloneTo),this.menu.webcam.$elm=o.createItem("webcam_link","webcam","tab").insertBefore(this.menu.webcam.cloneTo),this.container.webcam.$container.next().appendTo(this.container.webcam.cloneTo),this.container.webcam.$container.prependTo(this.container.webcam.cloneTo),$("<!-- ko allowBindings: false -->").insertBefore(this.container.$elm),$("<!-- /ko -->").insertAfter(this.container.$elm),$("#webcam_container").attr("data-bind",$("#webcam_container").attr("data-bind").replace("keydown: onKeyDown, ",""))}},TouchUI.prototype.DOM.move.afterTabAndNav=function(){this.DOM.create.dropdown.container.children().each(function(o,e){var t=$(e);$("<!-- ko allowBindings: false -->").insertBefore(t),$("<!-- /ko -->").insertAfter(t)}),$('<li class="divider"></li>').insertBefore("#navbar_settings"),$('<li class="divider" id="divider_systemmenu" style="display: none;"></li>').insertBefore("#navbar_systemmenu").attr("data-bind",$("#navbar_systemmenu").attr("data-bind"))},TouchUI.prototype.DOM.move.connection={$container:null,
containerId:"connection_dialog",$cloneContainer:$("#usersettings_dialog"),$cloneModal:$("#connection_wrapper"),cloneTo:"#all_touchui_settings > ul",init:function(o){var e=this.$cloneModal.find(".accordion-heading").text().trim();this.$container=this.$cloneContainer.clone().attr("id",this.containerId).insertAfter(this.$cloneContainer),this.$containerBody=this.$container.find(".modal-body"),this.$containerBody.html(""),this.$cloneModal.appendTo(this.$containerBody),this.$container.find(".modal-header h3").text(e),this.$menuItem=o.createItem("conn_link2",this.containerId,"modal",e).prependTo(this.cloneTo)}},TouchUI.prototype.DOM.move.controls={init:function(){if(0===$("#control-jog-feedrate").length){var o=$("#control > .jog-panel");$(o[0]).find(".jog-panel:nth-child(1)").attr("id","control-jog-xy"),$(o[0]).find(".jog-panel:nth-child(2)").attr("id","control-jog-z"),$(o[1]).attr("id","control-jog-extrusion"),$(o[2]).attr("id","control-jog-general"),$('<div class="jog-panel" id="control-jog-feedrate"></div>').insertAfter($(o[2])),$(o[0]).find("> button:last-child").prependTo("#control-jog-feedrate"),$(o[0]).find("> input:last-child").prependTo("#control-jog-feedrate"),$(o[0]).find("> .slider:last-child").prependTo("#control-jog-feedrate")}$("#control-jog-feedrate").attr("data-bind",$("#control-jog-extrusion").data("bind")).insertAfter("#control-jog-extrusion"),$("#control-jog-extrusion button:last-child").prependTo("#control-jog-feedrate"),$("#control-jog-extrusion input:last-child").prependTo("#control-jog-feedrate"),$("#control-jog-extrusion .slider:last-child").prependTo("#control-jog-feedrate"),$("#control div.distance").prependTo("#control-jog-feedrate"),$("#control-jog-feedrate").insertBefore("#control-jog-extrusion")}},TouchUI.prototype.DOM.move.navbar={mainItems:["#all_touchui_settings","#navbar_plugin_navbartemp","#navbar_login",".hidden_touch"],init:function(){$items=$("#navbar ul.nav > li:not("+this.DOM.move.navbar.mainItems+")"),$items.each(function(o,e){var t=$(e);t.appendTo(this.DOM.create.dropdown.container),t.find("a").text(t.text().trim())}.bind(this)),$("#navbar_plugin_touchui").insertAfter("#navbar_settings"),$('<li><ul id="youcanhazlogin"></ul></li>').insertAfter("#navbar_plugin_touchui"),$("#navbar_login").appendTo("#youcanhazlogin").find("a.dropdown-toggle").text($("#youcanhazlogin").find("a.dropdown-toggle").text().trim()),this.plugins.navbarTemp.call(this)}},TouchUI.prototype.DOM.move.overlays={mainItems:["#offline_overlay","#reloadui_overlay","#drop_overlay"],init:function(){$(this.DOM.move.overlays.mainItems).each(function(o,e){var t=$(e);t.appendTo("body")}.bind(this))}},TouchUI.prototype.DOM.move.tabbar={mainItems:["#print_link","#temp_link","#control_link","#webcam_link","#term_link",".hidden_touch"],init:function(){$items=$("#tabs > li:not("+this.DOM.move.tabbar.mainItems+")"),$items.each(function(o,e){var t=$(e);t.clone().attr("id",t.attr("id")+"2").appendTo("#all_touchui_settings .dropdown-menu").find("a").off("click").on("click",function(o){return t.find("a").click(),$("#all_touchui_settings").addClass("item_active"),o.preventDefault(),!1}),t.addClass("hidden_touch")}.bind(this)),$items=$("#tabs > li > a"),$items.each(function(o,e){$(e).text("")}.bind(this))}},TouchUI.prototype.DOM.move.terminal={init:function(){$("<span></span>").prependTo("#terminal-output");var o=$('<div id="terminal-scroll"></div>').insertBefore("#terminal-output"),e=$('<div id="terminal-scroll-inner"></div>').appendTo(o);$("#terminal-output").appendTo(e),$("#terminal-output-lowfi").appendTo(e)}},TouchUI.prototype.DOM.overwrite.modal=function(){$.fn.modalBup=$.fn.modal,$.fn.modal=function(o,e){$.fn.modalBup.defaults=$.fn.modal.defaults;var t=$(this).modalBup(o,e);return $(this).trigger("modal.touchui",this),t},$.fn.modal.prototype={constructor:$.fn.modal},$.fn.modal.Constructor=$.fn.modal,$.fn.modal.defaults=$.fn.modalBup.defaults},TouchUI.prototype.DOM.overwrite.tabbar=function(){$("#tabs [data-toggle=tab]").each(function(o,e){var t=$.extend([],jQuery._data(e,"events").show),n=$(e);n.off("show").on("show",function(o){var e=this,n=o.target.hash,i=o.relatedTarget.hash;n="#control"===n?"#control_without_webcam":n,n="#webcam"===n?"#control":n,i="#control"===i?"#control_without_webcam":i,i="#webcam"===i?"#control":i,$.each(t,function(o,t){t.handler.call(e,{target:{hash:n},relatedTarget:{hash:i}})})})})},TouchUI.prototype.DOM.overwrite.tabdrop=function(){$.fn.tabdrop=function(){},$.fn.tabdrop.prototype={constructor:$.fn.tabdrop},$.fn.tabdrop.Constructor=$.fn.tabdrop};